// ============================================================
//  DARKZONE-MD Database Manager
//  Created By Irfan Ahmad
// ============================================================

const Sequelize = require('sequelize');

class DatabaseManager {
    static instance = null;

    static getInstance() {
        if (!DatabaseManager.instance) {
            const DATABASE_URL = process.env.DATABASE_URL || './database.db';

            if (DATABASE_URL === './database.db') {
                DatabaseManager.instance = new Sequelize({
                    dialect: 'sqlite',
                    storage: DATABASE_URL,
                    logging: false,
                });
            } else {
                DatabaseManager.instance = new Sequelize(DATABASE_URL, {
                    dialect: 'postgres',
                    ssl: true,
                    protocol: 'postgres',
                    dialectOptions: {
                        native: true,
                        ssl: { require: true, rejectUnauthorized: false },
                    },
                    logging: false,
                });
            }
        }
        return DatabaseManager.instance;
    }
}

const DATABASE = DatabaseManager.getInstance();

// Sync with error handling — non-blocking
DATABASE.sync()
    .then(() => {
        console.log('[✅] Database synchronized');
    })
    .catch((error) => {
        console.error('[❌] Database sync error:', error.message);
    });

module.exports = { DATABASE };